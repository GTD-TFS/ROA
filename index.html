<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>R.O.A. ‚Äì Carga desde Excel y Generaci√≥n ODT</title>

  <!-- Librer√≠as (defer para cargarlas sin bloquear y en orden) -->
  <script src="./jszip.min.js" defer></script>
  <script src="./FileSaver.min.js" defer></script>
  <script src="./xlsx.full.min.js" defer></script>
  <script src="./plantilla_roa.js" defer></script>

  <script>
  // Carga XLSX si no existe; primero intenta local, luego CDN
  (function () {
    function loadScript(src, ok, fail){
      var s=document.createElement('script');
      s.src=src; s.onload=ok; s.onerror=fail || function(){};
      document.head.appendChild(s);
    }
    window.ensureXLSX = function (cb){
      if (window.XLSX) { cb(); return; }
      // 1) si por alg√∫n motivo el 'defer' no lo carg√≥ a√∫n, reintenta local
      loadScript('./xlsx.full.min.js', function(){ cb(); }, function(){
        // 2) fallback CDN
        loadScript('https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js', cb, function(){
          const m = document.getElementById('message');
          if (m) m.innerText = '‚ùå No se pudo cargar XLSX (local ni CDN).';
          console.error('No se pudo cargar XLSX desde local ni CDN');
        });
      });
    };
  })();
</script>


  <style>
    :root{
      --bg:#0f172a;
      --panel:#0b1222;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --primary:#2563eb;
      --primary-2:#1d4ed8;
      --accent:#14b8a6;
      --card:#111827;
      --border:#243042;
      --radius:12px;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; font-family:Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 50% -200px, #12223d 0%, #0a0f1e 60%, #05060b 100%);
      color:var(--text);
      display:flex; flex-direction:column;
    }

    header{ width:100%; padding:16px 24px 0; }
    .title{
      max-width:1600px; margin:0 auto;
      display:flex; align-items:center; justify-content:center; gap:16px;
    }
    .title h1{
      margin:0; font-size:28px; font-weight:800; letter-spacing:.5px;
      color:#cfe3ff; text-shadow:0 2px 14px rgba(29,78,216,.55);
    }

    .actions{
      max-width:1600px; margin:12px auto 0;
      display:flex; gap:12px; justify-content:center; flex-wrap:wrap;
    }
    .btn{
      background:var(--primary);
      border:1px solid var(--primary-2);
      color:white; padding:12px 16px; border-radius:10px;
      font-weight:800; text-transform:uppercase; letter-spacing:.6px;
      cursor:pointer;
      transition:transform .06s ease, box-shadow .12s ease;
    }
    .btn:hover{ transform:translateY(-1px); box-shadow:0 8px 20px rgba(37,99,235,.25); }
    .btn.secondary{ background:#0b1b33; border-color:#193052; }
    .btn.ok{ background:#15803d; border-color:#166534; }
    .btn.warn{ background:#b45309; border-color:#166534; }

    main{ width:100%; margin:16px 0 40px; display:flex; justify-content:center; }
    .wrap{
      width:clamp(1100px, 95vw, 1600px);
      background:linear-gradient(180deg, rgba(8,15,30,.7), rgba(8,15,30,.85));
      border:1px solid var(--border);
      box-shadow:0 30px 60px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.03);
      border-radius:16px; padding:22px 26px;
    }

    h2{
      margin:18px 0 8px; font-size:18px; letter-spacing:.4px; text-transform:uppercase;
      color:#b9d3ff; display:flex; align-items:center; gap:10px;
      border-bottom:2px solid #1f3b69; padding-bottom:6px;
    }

    .grid{ display:grid; gap:10px; grid-template-columns: repeat(4, minmax(180px,1fr)); }
    @media (max-width: 1280px){ .grid{ grid-template-columns: repeat(3, minmax(180px,1fr)); } }
    @media (max-width: 980px){ .grid{ grid-template-columns: repeat(2, minmax(180px,1fr)); } }

    .card{
      background:linear-gradient(180deg, #0c1428, #0a1121);
      border:1px solid var(--border);
      border-radius:10px; padding:10px 10px 8px;
      display:flex; flex-direction:column; gap:6px; min-height:64px;
    }
    label{
      font-size:12px; font-weight:800; text-transform:uppercase; letter-spacing:.6px;
      color:#9cc2ff;
    }
    input, select, textarea{
      width:100%; padding:7px 8px;
      border-radius:8px; border:1px solid #2a3955; background:#f8fafc;
      color:#0b1222; font-size:14px; outline:none;
    }
    textarea{ min-height:64px; resize:vertical; }
    input:focus, select:focus, textarea:focus{ box-shadow:0 0 0 2px rgba(100,180,255,.25); border-color:#4b86df; }

    .full{ grid-column: 1 / -1; }

    #message{ margin-top:12px; text-align:center; font-weight:700; color:#bfe5ff; min-height: 24px; }

    .mini{ display:none }
  </style>
</head>
<body>

  <header>
    <div class="title">
      <h1>RESUMEN OPERATIVO ARCHIVA (R.O.A.)</h1>
    </div>
  </header>

  <main>
    <div class="wrap">
      <!-- Apartado 1 -->
      <h2>ü™™ Identificaci√≥n</h2>
      <div class="grid">
        <div class="card">
          <label>Tipo de documento</label>
          <select id="tipoDocumento" name="TIPO DOCUMENTO_OPCION">
            <option value="INDOCUMENTADO/A">INDOCUMENTADO/A</option>
            <option value="DNI">DNI</option>
            <option value="NIE">NIE</option>
            <option value="PASAPORTE">PASAPORTE</option>
            <option value="OTRO">OTRO</option>
          </select>
          <input type="text" id="tipoDocumentoOtro" name="TIPO DOCUMENTO" placeholder="Especificar otro" style="display:none;">
        </div>

        <div class="card">
          <label>NUMERO DE DOCUMENTO</label>
          <input type="text" id="numeroDocumento" name="N√öMERO DE DOCUMENTO">
        </div>

        <div class="card"><label>Nombre</label><input type="text" name="NOMBRE"></div>
        <div class="card"><label>Primer apellido</label><input type="text" name="PRIMER APELLIDO"></div>
        <div class="card"><label>Segundo apellido</label><input type="text" name="SEGUNDO APELLIDO"></div>
        <div class="card"><label>Fecha de nacimiento</label><input type="text" name="FECHA DE NACIMIENTO" placeholder="DD/MM/AAAA"></div>
        <div class="card"><label>Lugar de nacimiento</label><input type="text" name="LUGAR DE NACIMIENTO"></div>
        <div class="card"><label>Provincia</label><input type="text" name="PROVINCIA"></div>
        <div class="card"><label>PA√çS</label><input type="text" name="PA√çS"></div>
        <div class="card"><label>NACIONALIDAD</label><input type="text" name="NACIONALIDAD"></div>
        <div class="card"><label>Nombre de los padres</label><input type="text" name="NOMBRE DE LOS PADRES"></div>
        <div class="card"><label>PROFESI√ìN</label><input type="text" name="PROFESI√ìN"></div>
      </div>

      <!-- Apartado 2 -->
      <h2>üìÇ Entorno y Actividad</h2>
      <div class="grid">
        <div class="card"><label>Tel√©fono</label><input type="text" name="TEL√âFONO" placeholder="TEL√âFONO"></div>
        <div class="card"><label>Armas</label><input type="text" name="ARMAS"></div>
        <div class="card"><label>Alias</label><input type="text" name="ALIAS"></div>
        <div class="card"><label>Consortes</label><input type="text" name="CONSORTES"></div>
        <div class="card"><label>Domicilios</label><input type="text" name="DOMICILIOS"></div>
        <div class="card"><label>Empresas</label><input type="text" name="EMPRESAS"></div>
        <div class="card"><label>Lugares de actuaci√≥n</label><input type="text" name="LUGARES DE ACTUACION"></div>
        <div class="card"><label>Lugares de frecuencia</label><input type="text" name="LUGARES DE FRECUENCIA"></div>
        <div class="card"><label>Organizaci√≥n</label><input type="text" name="ORGANIZACION"></div>
      </div>

      <!-- Apartado 3 -->
      <h2>üß¨ Rasgos f√≠sicos</h2>
      <div class="grid">
        <div class="card">
          <label>Sexo</label>
          <select name="SEXO" id="sexo">
            <option value="">--</option>
            <option value="H">Masculino</option>
            <option value="M">Femenino</option>
          </select>
        </div>

        <div class="card"><label>Talla</label><input type="text" name="TALLA"></div>
        <div class="card"><label>Complexi√≥n</label><input type="text" name="COMPLEXION"></div>
        <div class="card"><label>Raza</label><input type="text" name="RAZA"></div>
        <div class="card"><label>Acento</label><input type="text" name="ACENTO"></div>
        <div class="card"><label>Cejas</label><input type="text" name="CEJAS"></div>
        <div class="card"><label>Labios</label><input type="text" name="LABIOS"></div>
        <div class="card"><label>Ment√≥n</label><input type="text" name="MENTON"></div>
        <div class="card"><label>Cara</label><input type="text" name="CARA"></div>
        <div class="card"><label>Pelo</label><input type="text" name="PELO"></div>
        <div class="card"><label>Ojos</label><input type="text" name="OJOS"></div>
        <div class="card"><label>Nariz</label><input type="text" name="NARIZ"></div>
        <div class="card"><label>Orejas</label><input type="text" name="OREJAS"></div>
        <div class="card full"><label>Marcas</label><textarea name="MARCAS"></textarea></div>
      </div>

      <!-- Apartado 4 -->
      <h2>üöó Otros</h2>
      <div class="grid">
        <div class="card"><label>Usas</label><input type="text" name="USAS"></div>
        <div class="card"><label>Veh√≠culos</label><input type="text" name="VEHICULOS"></div>
      </div>

      <!-- Apartado 5 -->
      <h2>üìù Observaciones</h2>
      <div class="grid">
        <div class="card"><label>Diligencias</label><input type="text" name="DILIGENCIAS"></div>
        <div class="card"><label>Fecha diligencias</label><input type="text" name="FECHA DILIGENCIAS" placeholder="DD/MM/AAAA"></div>
        <div class="card full">
          <label>Resumen diligencias</label>
          <textarea name="RESUMEN DILIGENCIAS"></textarea>
        </div>
      </div>

      <!-- Apartado 6 -->
      <h2>üëÆ Finalizaci√≥n</h2>
      <div class="grid">
        <div class="card"><label>Funcionario emisor</label><input type="text" name="FUNCIONARIO EMISOR"></div>
        <div class="card"><label>Fecha de cumplimentaci√≥n</label><input type="text" name="FECHA DE CUMPLIMENTACION" placeholder="DD/MM/AAAA"></div>
      </div>

      <div id="message"></div>
    </div>
  </main>

  <!-- Botones abajo -->
  <div class="actions">
    <input type="file" id="fileInputXLSX" class="mini" accept=".xlsx,.xls" />
    <button class="btn secondary" type="button" style="background:#BDB76B" onclick="cargarExcel()">üìÅ Cargar EXCEL</button>
    <button class="btn ok"        type="button" style="background:#006400" onclick="generarROA()">‚¨áÔ∏è Descargar R.O.A.</button>
    <button class="btn warn"      type="button" style="background:#0000FF" onclick="refrescarFuerte()">‚ü≤ Refrescar</button>
  </div>

  <!-- Normalizador de placeholders rotos -->
  <script>
  (function () {
    const FIELD_MAP = {
      "PA√çS": ["PAIS", "PA√çS"],
      "NACIONALIDAD": ["NACIONALIDAD"],
      "N√öMERO DE DOCUMENTO": ["NUMERO DE DOCUMENTO","N√öMERO DE DOCUMENTO","NUMERO DOCUMENTO","N√öMERO DOCUMENTO"],
      "PROFESI√ìN": ["PROFESION","PROFESI√ìN"],
      "TIPO DOCUMENTO": ["TIPO DOCUMENTO","TIPO DE DOCUMENTO"]
    };
    const stripAccents = s => s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    const esc = s => s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
    const SEP = String.raw`(?:\s|<[^>]+>|&nbsp;)*`;
    const lettersPat = s => s.split('').map(ch => esc(ch)).join(SEP);
    function makeBrokenTokenRx(token){
      const up = token.toUpperCase();
      const upNoAcc = stripAccents(up);
      const inner = `(?:${lettersPat(up)}|${lettersPat(upNoAcc)})`;
      const pattern = String.raw`\{${SEP}\{${SEP}${inner}${SEP}\}${SEP}\}`;
      return new RegExp(pattern,'gsi');
    }
    function normalizeHtml(html, outKey, variants){
      for(const v of variants){ html = html.replace(makeBrokenTokenRx(v), `{{${outKey}}}`); }
      const tight = new RegExp(String.raw`\{\{\s*${esc(outKey)}\s*\}\}`,'gi');
      return html.replace(tight, `{{${outKey}}}`);
    }
    const root = document.body;
    let html = root.innerHTML;
    for(const [outKey, variants] of Object.entries(FIELD_MAP)){
      html = normalizeHtml(html, outKey, variants);
    }
    root.innerHTML = html;
  })();
  </script>

  <!-- Tu script principal -->
  <script>
  async function refrescarFuerte(){
    try{
      if ('caches' in window){
        const keys = await caches.keys();
        await Promise.all(keys.map(k => caches.delete(k)));
      }
      if ('serviceWorker' in navigator){
        const regs = await navigator.serviceWorker.getRegistrations();
        await Promise.all(regs.map(r => r.unregister()));
      }
    }catch(e){}
    window.location.reload();
  }

  // ============ Helpers ============
  function norm(s){
    return String(s ?? "")
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/¬∫|¬∞/g,"O")
      .toUpperCase()
      .replace(/[^A-Z0-9]/g,"")
      .trim();
  }
  function isKey(campo, variantes){
    const n = norm(campo);
    return variantes.some(v => n === norm(v));
  }
  function findFieldByName(name){ return document.querySelector(`[name="${name}"]`); }
  function ddmmyyyy_from_excel(v){
    if(typeof v === "number"){
      const epoch = new Date(Date.UTC(1899,11,30));
      const d = new Date(epoch.getTime() + v*86400000);
      const dd = String(d.getUTCDate()).padStart(2,'0');
      const mm = String(d.getUTCMonth()+1).padStart(2,'0');
      const yy = d.getUTCFullYear();
      return `${dd}/${mm}/${yy}`;
    }
    const s = String(v||"").trim();
    let m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
    if(m){ const dd=m[1].padStart(2,'0'), mm=m[2].padStart(2,'0'), yyyy=m[3].length===2?`20${m[3]}`:m[3]; return `${dd}/${mm}/${yyyy}`; }
    m = s.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
    if(m){ const yyyy=m[1], mm=String(m[2]).padStart(2,'0'), dd=String(m[3]).padStart(2,'0'); return `${dd}/${mm}/${yyyy}`; }
    return s;
  }

  // ============ Aliases Excel ============
  const FIELD_ALIASES = new Map([
    ["NOMBRE","NOMBRE"],["NOMBRES","NOMBRE"],
    ["LUGARDENACIMIENTO","LUGAR DE NACIMIENTO"],["LUGARNACIMIENTO","LUGAR DE NACIMIENTO"],
    ["NACIONALIDAD","NACIONALIDAD"],
    ["NOMBREDELOSPADRES","NOMBRE DE LOS PADRES"],["NOMBRESDELOSPADRES","NOMBRE DE LOS PADRES"],["NOMBRESPADRES","NOMBRE DE LOS PADRES"],["PADRES","NOMBRE DE LOS PADRES"],
    ["TELEFONO","TELEFONO"],["TEL√âFONO","TELEFONO"],["TLF","TELEFONO"],["MOVIL","TELEFONO"],["M√ìVIL","TELEFONO"],["CELULAR","TELEFONO"],
    ["DOMICILIO","DOMICILIOS"],["DOMICILIOS","DOMICILIOS"],
    ["DILIGENCIAS","DILIGENCIAS"],["RESUMENDILIGENCIAS","RESUMEN DILIGENCIAS"],["FECHADILIGENCIAS","FECHA DILIGENCIAS"],
    ["NUMERODEDOCUMENTO","NUMERO DE DOCUMENTO"],["NDOCUMENTO","N√öMERO DE DOCUMENTO"],["NDOC","N√öMERO DE DOCUMENTO"],
    ["FECHADENACIMIENTO","FECHA DE NACIMIENTO"],["NACIMIENTOFECHA","FECHA DE NACIMIENTO"],["FECHADECUMPLIMENTACION","FECHA DE CUMPLIMENTACION"],
  ]);
  function findFieldByKey(key){
    if(!key) return null;
    const raw = String(key).trim();
    let el = document.querySelector(`[name="${raw}"]`);
    if(el) return el;
    const alias = FIELD_ALIASES.get(norm(raw));
    if(alias){
      el = document.querySelector(`[name="${alias}"]`);
      if(el) return el;
    }
    const target = norm(raw);
    for(const cand of document.querySelectorAll('[name]')){
      if(norm(cand.getAttribute('name')) === target) return cand;
    }
    return null;
  }

  // ============ UI: tipo documento ============
  document.addEventListener('change', e=>{
    if(e.target.id==="tipoDocumento"){
      const val=e.target.value;
      const otro=document.getElementById('tipoDocumentoOtro');
      const num=document.getElementById('numeroDocumento');
      if(val==="OTRO"){ if(otro){ otro.style.display="block"; } }
      else { if(otro){ otro.style.display="none"; otro.value=""; } }
      if(val==="INDOCUMENTADO/A"){ if(num){ num.value=""; num.disabled=true; } }
      else { if(num){ num.disabled=false; } }
    }
  });
  function setTipoDocumentoDesdeExcel(valor){
    const sel  = document.getElementById("tipoDocumento");
    const otro = document.getElementById("tipoDocumentoOtro");
    if(!sel) return;
    const v = (valor||"").toString().trim();
    const vNorm = norm(v);
    let matched = false;
    for(const opt of sel.options){
      if(norm(opt.value) === vNorm){ sel.value = opt.value; matched = true; break; }
    }
    if(!matched){ sel.value = "OTRO"; if(otro){ otro.style.display = "block"; otro.value = v; } }
    else { if(otro){ otro.style.display = "none"; otro.value = ""; } }
    sel.dispatchEvent(new Event("change", {bubbles:true}));
  }
  function setNumeroDocumentoDesdeExcel(valor){
    const el = document.getElementById("numeroDocumento");
    if(!el) return;
    el.value = (valor ?? "").toString().trim();
  }

  // ============ Lectura Excel (robusto) ============
  function rowsToPairs(rows){
    if(!Array.isArray(rows) || !rows.length) return [];
    const nonEmptyLens = rows.map(r => (Array.isArray(r)? r : []).filter(c => String(c ?? '').trim() !== '').length);
    const maxLen = Math.max(0, ...nonEmptyLens);
    if(maxLen <= 2){
      return rows.map(r => [r?.[0], r?.[1]]).filter(([k]) => String(k ?? '').trim() !== '');
    }
    const headers = (rows[0] || []).map(h => String(h ?? '').trim());
    const dataRow = rows.find((r,i) => i>0 && (r||[]).some(c => String(c ?? '').trim() !== '')) || [];
    return headers.map((h,i) => [h, dataRow[i]]).filter(([k]) => String(k ?? '').trim() !== '');
  }

  <script>
  async function cargarExcel(){
    const input = document.getElementById("fileInputXLSX");
    input.value = null;

    // el handler ahora garantiza XLSX antes de procesar
    input.onchange = function (e) {
      ensureXLSX(function () {
        var file = (e && e.target && e.target.files && e.target.files[0]) ? e.target.files[0] : null;
        if (!file) {
          document.getElementById("message").innerText = "‚ö†Ô∏è No se seleccion√≥ ning√∫n archivo.";
          return;
        }
        function procesarBuf(buf) {
          try {
            var wb = XLSX.read(buf, { type: "array" });
            if (!wb.SheetNames || wb.SheetNames.length === 0) {
              document.getElementById("message").innerText = "‚ö†Ô∏è El Excel no tiene hojas.";
              return;
            }
            var sheet = wb.Sheets[wb.SheetNames[0]];
            if (!sheet) {
              document.getElementById("message").innerText = "‚ö†Ô∏è La primera hoja est√° vac√≠a.";
              return;
            }
            var rows = XLSX.utils.sheet_to_json(sheet, { header: 1, blankrows: false, defval: "" });

            const pairs = rowsToPairs(rows);
            let rellenados = 0;
            let fechaGeneracionExcel = "";

            for (var i = 0; i < pairs.length; i++) {
              var campo = pairs[i][0];
              var valor = pairs[i][1];
              if (!campo) continue;
              const key = String(campo).trim();
              let v = valor;

              // ======== tu l√≥gica tal cual ========
              if (isKey(key, ["SEXO","GENERO"])) {
                const val = String(v || "").trim().toUpperCase();
                const el = document.getElementById("sexo");
                if (el) {
                  if (val.startsWith("H") || val.indexOf("MASC") >= 0) el.value = "H";
                  else if (val.startsWith("M") || val.indexOf("FEM") >= 0) el.value = "M";
                }
                rellenados++; continue;
              }
              if (isKey(key, ["TELEFONO","TEL√âFONO","TLF","MOVIL","M√ìVIL","CELULAR"])) {
                const el = findFieldByKey("TELEFONO");
                if (el) { el.value = (v ?? "").toString(); rellenados++; }
                continue;
              }
              if (isKey(key, ["FECHA GENERACION","FECHA DE GENERACION","FECHA_GENERACION"])) {
                fechaGeneracionExcel = ddmmyyyy_from_excel(v); continue;
              }
              if (isKey(key, ["TIPO DOCUMENTO","TIPO DE DOCUMENTO","TIPO_DOC","TIPO"])) {
                setTipoDocumentoDesdeExcel(v); rellenados++; continue;
              }
              if (isKey(key, [
                "N¬∫ DOCUMENTO","N¬∫DOCUMENTO","NUMERO DE DOCUMENTO","N√öMERO DE DOCUMENTO",
                "NUMERO DOCUMENTO","N√öMERO DOCUMENTO","N DOC","N DOCUMENTO","NDOCUMENTO",
                "NUMERODEDOCUMENTO","NDOC"
              ])) {
                setNumeroDocumentoDesdeExcel(v); rellenados++; continue;
              }
              if (isKey(key, ["APELLIDOS"])) {
                const s = String(v||"").trim();
                if (s) {
                  const partes = s.split(/\s+/).map(t=>t.trim()).filter(Boolean);
                  const primero = findFieldByName("PRIMER APELLIDO");
                  const segundo  = findFieldByName("SEGUNDO APELLIDO");
                  if (primero){ primero.value = (partes[0]||""); rellenados++; }
                  if (segundo){ segundo.value = (partes[1]||""); rellenados++; }
                }
                continue;
              }
              if (isKey(key, ["FECHA DE NACIMIENTO","FECHA NACIMIENTO","NACIMIENTO","FECHADENACIMIENTO"])) {
                const el = findFieldByKey("FECHA DE NACIMIENTO");
                if (el){ el.value = ddmmyyyy_from_excel(v); rellenados++; }
                continue;
              }
              if (isKey(key, ["FECHA DILIGENCIAS","FECHADILIGENCIAS"])) {
                const el = findFieldByKey("FECHA DILIGENCIAS");
                if (el){ el.value = ddmmyyyy_from_excel(v); rellenados++; }
                continue;
              }
              if (isKey(key, ["FECHA DE CUMPLIMENTACION","FECHA CUMPLIMENTACION","FECHADECUMPLIMENTACION"])) {
                const el = findFieldByKey("FECHA DE CUMPLIMENTACION");
                if (el){ el.value = ddmmyyyy_from_excel(v); rellenados++; }
                continue;
              }
              const el = findFieldByKey(key);
              if (el){ el.value = (v ?? "").toString(); rellenados++; }
            }

            if (fechaGeneracionExcel) {
              const f1 = findFieldByKey("FECHA DILIGENCIAS");
              const f2 = findFieldByKey("FECHA DE CUMPLIMENTACION");
              if (f1 && !String(f1.value||"").trim()){ f1.value = fechaGeneracionExcel; rellenados++; }
              if (f2 && !String(f2.value||"").trim()){ f2.value = fechaGeneracionExcel; rellenados++; }
            }

            document.getElementById("message").innerText = "‚úÖ XLSX cargado: " + rellenados + " campos asignados";
          } catch (err) {
            console.error(err);
            document.getElementById("message").innerText = "‚ùå Error al cargar XLSX: " + (err && err.message ? err.message : err);
          }
        }

        if (file.arrayBuffer) {
          file.arrayBuffer().then(procesarBuf).catch(function (err) {
            console.error(err);
            document.getElementById("message").innerText = "‚ùå Error al leer archivo: " + (err && err.message ? err.message : err);
          });
        } else {
          var fr = new FileReader();
          fr.onload = function (ev) { procesarBuf(ev.target.result); };
          fr.onerror = function () {
            document.getElementById("message").innerText = "‚ùå Error con FileReader.";
          };
          fr.readAsArrayBuffer(file);
        }
      });
    };

    // abrir selector
    input.click();
  }
</script>

  // ============ ODT ============
  function getPlantillaROA(){
    if (typeof window !== 'undefined'){
      if (typeof window.PLANTILLA_ROA === 'string' && window.PLANTILLA_ROA.length) return window.PLANTILLA_ROA;
      if (window.PLANTILLAS && typeof window.PLANTILLAS.roa === 'string' && window.PLANTILLAS.roa.length) return window.PLANTILLAS.roa;
    }
    return '';
  }
  function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"); }
  function buildFlexibleRegex(key){
    const chars = key.split("").map(c=>escapeRegExp(c));
    const flexible = chars.join("(?:\\s|<[^>]+>|&nbsp;)*");
    return new RegExp("\\{\\{(?:\\s|<[^>]+>|&nbsp;)*"+flexible+"(?:\\s|<[^>]+>|&nbsp;)*\\}\\}","gi");
  }

  function reemplazarPlaceholdersODT(xml, dataUpper) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(xml, "application/xml");

    doc.querySelectorAll("*").forEach(node => {
      if (node.textContent && node.textContent.includes("{{")) {
        for (const k in dataUpper) {
          const v = dataUpper[k] ?? "";
          const regex = new RegExp("{{\\s*" + k + "\\s*}}", "gi");
          node.textContent = node.textContent.replace(regex, v);
        }
      }
    });

    doc.querySelectorAll("text\\:placeholder").forEach(ph => {
      const key = ph.textContent.trim().toUpperCase();
      if (dataUpper[key] !== undefined) ph.textContent = dataUpper[key];
    });

    doc.querySelectorAll("text\\:variable-set").forEach(v => {
      const key = (v.getAttribute("text:name") || "").toUpperCase();
      if (dataUpper[key] !== undefined) {
        v.setAttribute("office:string-value", dataUpper[key]);
        v.textContent = dataUpper[key];
      }
    });

    return new XMLSerializer().serializeToString(doc);
  }

  async function generarODTUint8(base64, dataUpper){
    const bytes = Uint8Array.from(atob(base64.replace(/[\r\n\t ]+/g,"")), c=>c.charCodeAt(0));
    const zip = await JSZip.loadAsync(bytes);
    let xml = await zip.file("content.xml").async("string");

    const phRegex = /\{\{([\s\S]*?)\}\}/g;
    const found = [];
    let m;
    while ((m = phRegex.exec(xml)) !== null){ found.push(m[1]); }
    if(found.length){
      const clean = s => s.replace(/<[^>]+>/g,'').replace(/&nbsp;/g,' ').replace(/\s+/g,' ').trim().toUpperCase();
      const byNorm = {};
      for(const k in dataUpper){ byNorm[norm(k)] = k; }
      for(const raw of found){
        const keyClean = clean(raw);
        const nkey = norm(keyClean);
        if(byNorm[nkey]){
          const canonical = byNorm[nkey];
          if(typeof dataUpper[keyClean] === 'undefined') dataUpper[keyClean] = dataUpper[canonical];
        }
      }
    }

    for(const k in dataUpper){
      const v = (dataUpper[k]??"").toString();
      xml = xml.replace(buildFlexibleRegex(k), v);
      xml = xml.replace(new RegExp("\\{\\{\\s*"+escapeRegExp(k)+"\\s*\\}\\}","g"), v);
    }

    xml = xml.replace(/{{\s*[^}]+\s*}}/g,"");

    zip.file("content.xml", xml);
    return await zip.generateAsync({type:"uint8array", compression:"DEFLATE"});
  }

  async function saveBlob(blob, filename){
    if(window.showSaveFilePicker){
      try{
        const handle = await window.showSaveFilePicker({
          suggestedName:filename,
          types:[{description:'ODT', accept:{'application/vnd.oasis.opendocument.text':['.odt']}}]
        });
        const writable = await handle.createWritable();
        await writable.write(blob); await writable.close(); return;
      }catch(e){ /* fallback */ }
    }
    const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a);
    a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 1200);
  }

  function U(s){ return String(s ?? '').toUpperCase(); }

  async function generarROA(){
    const msg = document.getElementById("message");
    msg.innerText = "Generando R.O.A....";
    try{
      const plantilla = getPlantillaROA();
      if(!plantilla){
        msg.innerText = "‚ùå No se encontr√≥ la plantilla. Aseg√∫rate de que 'plantilla_roa.js' defina 'window.PLANTILLA_ROA' o 'window.PLANTILLAS.roa'.";
        return;
      }

      const data = {};
      document.querySelectorAll("[name]").forEach(el=>{ data[el.name] = el.value ?? ""; });

      const tipoOpt = document.getElementById("tipoDocumento")?.value || "";
      const tipoOtro = document.getElementById("tipoDocumentoOtro")?.value || "";
      data["TIPO DOCUMENTO"] = (tipoOpt==="OTRO") ? tipoOtro : tipoOpt;
      if(tipoOpt==="INDOCUMENTADO/A"){
        const nd = document.getElementById("numeroDocumento");
        if(nd){ nd.value=""; }
        data["N√öMERO DE DOCUMENTO"] = "";
      }

      const sexoEl = document.getElementById("sexo");
      if (sexoEl) {
        const raw = (sexoEl.value || sexoEl.options[sexoEl.selectedIndex]?.text || "").toUpperCase();
        data["SEXO"] =
          (raw.startsWith("H") || raw.includes("MASC")) ? "H" :
          (raw.startsWith("M") || raw.includes("FEM")) ? "M" : (data["SEXO"] || "");
      }

      const dataUpper = {};
      for(const k in data){ dataUpper[k] = U(data[k]); }

      // --- ALIAS DIRECTOS ---
      dataUpper["PA√çS"] = dataUpper["PA√çS"] || dataUpper["PAIS"] || "";
      dataUpper["PAIS"] = dataUpper["PAIS"] || dataUpper["PA√çS"] || "";
      dataUpper["PROFESI√ìN"] = dataUpper["PROFESI√ìN"] || dataUpper["PROFESION"] || "";
      dataUpper["PROFESION"] = dataUpper["PROFESION"] || dataUpper["PROFESI√ìN"] || "";
      dataUpper["NUMERO DE DOCUMENTO"] = dataUpper["NUMERO DE DOCUMENTO"] || dataUpper["N√öMERO DE DOCUMENTO"] || "";
      dataUpper["N√öMERO DE DOCUMENTO"] = dataUpper["N√öMERO DE DOCUMENTO"] || dataUpper["NUMERO DE DOCUMENTO"] || "";
      dataUpper["TIPO DOCUMENTO"] = dataUpper["TIPO DOCUMENTO"] || "";
      dataUpper["SEXO"] = dataUpper["SEXO"] || ((data["SEXO"] || "").toUpperCase());

      // Variantes comunes
      (function(){
        const sinAcentos = s => s.normalize("NFD").replace(/[\u0300-\u036f]/g,"");
        const compact = s => s.replace(/\s+/g," ").trim();
        const add = (k, v) => { if (typeof dataUpper[k] === "undefined") dataUpper[k] = v; };
        const snap = {...dataUpper};
        for (const k in snap){
          const v = snap[k];
          const base = compact(k.toUpperCase());
          const noAcc = sinAcentos(base);
          const sinDe  = compact(base.replace(/\bDE\b/g,""));
          const sinDeNoAcc = sinAcentos(sinDe);
          add(noAcc, v); add(sinDe, v); add(sinDeNoAcc, v);
        }
        const SYN = {
          "N√öMERO DE DOCUMENTO": ["NUMERO DE DOCUMENTO","N DOCUMENTO","N¬∫ DOCUMENTO","NUM DOCUMENTO"],
          "TIPO DOCUMENTO":      ["TIPO DE DOCUMENTO","TIPO_DOC","TIPO"],
          "PAIS":                ["PA√çS"],
          "PROFESION":           ["PROFESI√ìN"],
          "ORGANIZACION":        ["ORGANIZACI√ìN"],
          "LUGARES DE ACTUACION":["LUGARES DE ACTUACI√ìN"],
          "TELEFONO":            ["TEL√âFONO"],
          "FECHA DILIGENCIAS":   ["FECHA DE DILIGENCIAS","F. DILIGENCIAS"],
          "SEXO":                ["SEXO (H/M)","GENERO","G√âNERO"]
        };
        for (const from in SYN){
          const v = dataUpper[from] ?? dataUpper[sinAcentos(from)];
          if (typeof v === "undefined") continue;
          SYN[from].forEach(alias => add(alias, v));
        }
      })();

      // Forzar placeholders exactos del ODT
      dataUpper["PA√çS"] = dataUpper["PA√çS"] || dataUpper["PAIS"] || "";
      dataUpper["NACIONALIDAD"] = dataUpper["NACIONALIDAD"] || "";
      dataUpper["PROFESI√ìN"] = dataUpper["PROFESI√ìN"] || dataUpper["PROFESION"] || "";
      dataUpper["TIPO DOCUMENTO"] = dataUpper["TIPO DOCUMENTO"] || (data["TIPO DOCUMENTO"] || "").toUpperCase();
      dataUpper["NUMERO DE DOCUMENTO"] =
        dataUpper["NUMERO DE DOCUMENTO"] ||
        dataUpper["N√öMERO DE DOCUMENTO"] ||
        (data["N√öMERO DE DOCUMENTO"] || "").toUpperCase();

      const odt = await generarODTUint8(plantilla, dataUpper);

      const nombre = (data["NOMBRE"]||"").trim();
      const a1 = (data["PRIMER APELLIDO"]||"").trim();
      const a2 = (data["SEGUNDO APELLIDO"]||"").trim();
      const base = [nombre,a1,a2].filter(Boolean).join("_").replace(/[\/\\:*?"<>|]+/g," ").trim() || "ROA";
      await saveBlob(new Blob([odt], {type:"application/vnd.oasis.opendocument.text"}), `${base}_ROA.odt`);
      msg.innerText = "‚úÖ R.O.A. generado";
    }catch(err){
      console.error(err);
      document.getElementById("message").innerText = "‚ùå Error al generar R.O.A.: " + (err?.message || err);
    }
  }

  // Inicial
  window.addEventListener("DOMContentLoaded", ()=>{
    const sel = document.getElementById("tipoDocumento");
    const otro = document.getElementById("tipoDocumentoOtro");
    if(sel && otro){ if(sel.value==="OTRO") otro.style.display="block"; else otro.style.display="none"; }
  });
  </script>
</body>
</html>
