<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>R.O.A. ‚Äì Carga desde Excel y Generaci√≥n ODT</title>

  <!-- Librer√≠as locales -->
  <script src="./jszip.min.js"></script>
  <script src="./FileSaver.min.js"></script>
  <script src="./xlsx.full.min.js"></script>
  <script src="./plantilla_roa.js"></script>

  <style>
    :root{
      --bg:#0f172a; --panel:#0b1222; --text:#e5e7eb; --border:#243042;
      --primary:#2563eb; --primary-2:#1d4ed8;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:Segoe UI, Roboto, Arial, sans-serif;
      background:#0f172a url('fondo_policia.jpg') no-repeat center center fixed;
      background-size:cover;
      color:var(--text);
    }
    header{ padding:12px; text-align:center; background:rgba(0,0,0,0.6); }
    h1{ margin:0; font-size:20px; }

    main{ display:flex; justify-content:center; padding:12px; }
    .wrap{
      width:100%;
      max-width:900px;
      background:rgba(11,18,34,0.92);
      border:1px solid var(--border);
      border-radius:12px;
      padding:14px;
    }
    h2{
      margin:16px 0 6px;
      font-size:14px;
      text-transform:uppercase;
      color:#b9d3ff;
      border-bottom:2px solid #1f3b69;
      padding-bottom:4px;
    }
    .grid{
      display:grid;
      gap:8px;
      grid-template-columns: repeat(1, 1fr); /* m√≥vil */
    }
    @media (min-width:600px){
      .grid{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (min-width:900px){
      .grid{ grid-template-columns: repeat(3, 1fr); }
    }
    .card{
      background:#111827;
      border:1px solid var(--border);
      border-radius:10px;
      padding:8px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    label{
      font-size:11px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:.4px;
      color:#9cc2ff;
    }
    input, select, textarea{
      width:100%;
      padding:7px 8px;
      border-radius:8px;
      border:1px solid #2a3955;
      background:#f8fafc;
      color:#0b1222;
      font-size:13px;
      outline:none;
    }
    textarea{ min-height:64px; resize:vertical; }

    .full{ grid-column:1 / -1; }
    #message{ margin-top:12px; text-align:center; font-weight:700; color:#bfe5ff; min-height:24px; }

    .actions{
      width:90%;
      max-width:400px;
      margin:16px auto;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
    }
    .btn{
      width:100%;
      background:var(--primary);
      border:1px solid var(--primary-2);
      color:#fff;
      padding:12px 16px;
      border-radius:10px;
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:.6px;
      cursor:pointer;
    }
    .btn.secondary{ background:#BDB76B; border-color:#BDB76B; color:#000; }
    .btn.ok{ background:#006400; border-color:#004d00; }
    .btn.warn{ background:#0000FF; border-color:#0000c8; }
    .mini{ display:none; }
  </style>
</head>
<body>
  <header><h1>RESUMEN OPERATIVO ARCHIVA (R.O.A.)</h1></header>

  <main>
    <div class="wrap">
      <!-- Identificaci√≥n -->
      <h2>ü™™ Identificaci√≥n</h2>
      <div class="grid">
        <div class="card">
          <label>Tipo de documento</label>
          <select id="tipoDocumento" name="TIPO DOCUMENTO">
            <option value="INDOCUMENTADO/A">INDOCUMENTADO/A</option>
            <option value="DNI">DNI</option>
            <option value="NIE">NIE</option>
            <option value="PASAPORTE">PASAPORTE</option>
            <option value="OTRO">OTRO</option>
          </select>
          <input type="text" id="tipoDocumentoOtro" placeholder="Especificar otro" style="display:none;">
        </div>
        <div class="card"><label>N√∫mero de documento</label><input id="numeroDocumento" name="N√öMERO DE DOCUMENTO"></div>
        <div class="card"><label>Nombre</label><input name="NOMBRE"></div>
        <div class="card"><label>Primer apellido</label><input name="PRIMER APELLIDO"></div>
        <div class="card"><label>Segundo apellido</label><input name="SEGUNDO APELLIDO"></div>
        <div class="card"><label>Fecha de nacimiento</label><input name="FECHA DE NACIMIENTO" placeholder="DD/MM/AAAA"></div>
        <div class="card"><label>Lugar de nacimiento</label><input name="LUGAR DE NACIMIENTO"></div>
        <div class="card"><label>Provincia</label><input name="PROVINCIA"></div>
        <div class="card"><label>Pa√≠s</label><input name="PA√çS"></div>
        <div class="card"><label>Nacionalidad</label><input name="NACIONALIDAD"></div>
        <div class="card"><label>Nombre de los padres</label><input name="NOMBRE DE LOS PADRES"></div>
        <div class="card"><label>Profesi√≥n</label><input name="PROFESI√ìN"></div>
      </div>

      <!-- Entorno y Actividad -->
      <h2>üìÇ Entorno y Actividad</h2>
      <div class="grid">
        <div class="card"><label>Tel√©fono</label><input name="TEL√âFONO"></div>
        <div class="card"><label>Armas</label><input name="ARMAS"></div>
        <div class="card"><label>Alias</label><input name="ALIAS"></div>
        <div class="card"><label>Consortes</label><input name="CONSORTES"></div>
        <div class="card"><label>Domicilios</label><input name="DOMICILIOS"></div>
        <div class="card"><label>Empresas</label><input name="EMPRESAS"></div>
        <div class="card"><label>Lugares de actuaci√≥n</label><input name="LUGARES DE ACTUACION"></div>
        <div class="card"><label>Lugares de frecuencia</label><input name="LUGARES DE FRECUENCIA"></div>
        <div class="card"><label>Organizaci√≥n</label><input name="ORGANIZACION"></div>
      </div>

      <!-- Rasgos f√≠sicos -->
      <h2>üß¨ Rasgos f√≠sicos</h2>
      <div class="grid">
        <div class="card">
          <label>Sexo</label>
          <select id="sexo" name="SEXO">
            <option value="">--</option>
            <option value="H">Masculino</option>
            <option value="M">Femenino</option>
          </select>
        </div>
        <div class="card"><label>Talla</label><input name="TALLA"></div>
        <div class="card"><label>Complexi√≥n</label><input name="COMPLEXION"></div>
        <div class="card"><label>Raza</label><input name="RAZA"></div>
        <div class="card"><label>Acento</label><input name="ACENTO"></div>
        <div class="card"><label>Cejas</label><input name="CEJAS"></div>
        <div class="card"><label>Labios</label><input name="LABIOS"></div>
        <div class="card"><label>Ment√≥n</label><input name="MENTON"></div>
        <div class="card"><label>Cara</label><input name="CARA"></div>
        <div class="card"><label>Pelo</label><input name="PELO"></div>
        <div class="card"><label>Ojos</label><input name="OJOS"></div>
        <div class="card"><label>Nariz</label><input name="NARIZ"></div>
        <div class="card"><label>Orejas</label><input name="OREJAS"></div>
        <div class="card full"><label>Marcas</label><textarea name="MARCAS"></textarea></div>
      </div>

      <!-- Otros -->
      <h2>üöó Otros</h2>
      <div class="grid">
        <div class="card"><label>Usas</label><input name="USAS"></div>
        <div class="card"><label>Veh√≠culos</label><input name="VEHICULOS"></div>
      </div>

      <!-- Observaciones -->
      <h2>üìù Observaciones</h2>
      <div class="grid">
        <div class="card"><label>Diligencias</label><input name="DILIGENCIAS"></div>
        <div class="card"><label>Fecha diligencias</label><input name="FECHA DILIGENCIAS" placeholder="DD/MM/AAAA"></div>
        <div class="card full"><label>Resumen diligencias</label><textarea name="RESUMEN DILIGENCIAS"></textarea></div>
      </div>

      <!-- Finalizaci√≥n -->
      <h2>üëÆ Finalizaci√≥n</h2>
      <div class="grid">
        <div class="card"><label>Funcionario emisor</label><input name="FUNCIONARIO EMISOR"></div>
        <div class="card"><label>Fecha de cumplimentaci√≥n</label><input name="FECHA DE CUMPLIMENTACION" placeholder="DD/MM/AAAA"></div>
      </div>

      <div id="message"></div>
    </div>
  </main>

  <!-- Acciones -->
  <div class="actions">
    <input type="file" id="fileInputXLSX" class="mini" accept=".xlsx,.xls"/>
    <button type="button" class="btn secondary" onclick="cargarExcel(event)">üìÅ Cargar EXCEL</button>
    <button type="button" class="btn ok" onclick="generarROA()">‚¨áÔ∏è Descargar R.O.A.</button>
    <button type="button" class="btn warn" onclick="location.reload()">‚ü≤ Refrescar</button>
  </div>

<script>
/* ===================== Helpers ===================== */
function normalizeKey(str){
  return str ? str.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toUpperCase().replace(/[^A-Z0-9]/g,"").trim() : "";
}
function ddmmyyyy_from_excel(v){ /* igual que ten√≠as */ }
function separarApellidos(s){ /* igual que ten√≠as */ }
function findFieldByName(name){ return document.querySelector(`[name="${name}"]`); }
function setTipoDocumentoDesdeExcel(v){ /* igual que ten√≠as */ }
function setNumeroDocumentoDesdeExcel(v){ /* igual que ten√≠as */ }

/* ===================== Carga Excel ===================== */
function cargarExcel(ev) {
  if (ev && ev.preventDefault) ev.preventDefault();
  const input = document.getElementById("fileInputXLSX");
  input.value = null;
  setTimeout(()=> input.click(),0);

  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    try {
      const data = await file.arrayBuffer();
      const workbook = XLSX.read(data, { type: "array" });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval:"" });
      /* ‚Ä¶ tu l√≥gica de asignaci√≥n de campos ‚Ä¶ */
      document.getElementById("message").innerText = "‚úÖ XLSX cargado";
    } catch(err){
      console.error(err);
      document.getElementById("message").innerText = "‚ùå Error al cargar XLSX: "+err.message;
    }
  };
}
</script>

<script>
/* ===================== ODT (igual que ten√≠as) ===================== */
function quitarAcentos(s){ return s.normalize("NFD").replace(/[\u0300-\u036f]/g,""); }
function escRegex(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"); }
function buildFlexibleRegex(key){
  const chars = quitarAcentos(key).toUpperCase().split("").map(escRegex);
  const SEP = String.raw`(?:\s|&nbsp;|<[^>]+>)*`;
  const inner = chars.join(SEP);
  return new RegExp(String.raw`\{\{${SEP}(?:${inner})${SEP}\}\}`,"g");
}

function buildODTDataUpper(){
  const data = {};
  document.querySelectorAll("[name]").forEach(el=>{
    data[el.name.toUpperCase()] = el.value ?? "";
  });

  const sel  = document.getElementById('tipoDocumento');
  const otro = document.getElementById('tipoDocumentoOtro');
  if(sel){ data["TIPO DOCUMENTO"] = (sel.value==="OTRO" ? (otro?.value||"") : sel.value); }

  const num  = document.getElementById('numeroDocumento');
  const sexo = document.getElementById('sexo');
  if(num)  data["N√öMERO DE DOCUMENTO"] = num.value;
  if(sexo) data["SEXO"] = sexo.value;

  if ((!data["PA√çS"] || !data["PA√çS"].trim()) && data["NACIONALIDAD"]) {
    data["PA√çS"] = data["NACIONALIDAD"];
    data["PAIS"] = data["NACIONALIDAD"];
  }
  if ((!data["PROVINCIA"] || !data["PROVINCIA"].trim()) && data["NACIONALIDAD"]) {
    data["PROVINCIA"] = data["NACIONALIDAD"];
  }
  if (data["PROFESI√ìN"] == null && data["PROFESION"] != null) data["PROFESI√ìN"] = data["PROFESION"];
  if (data["PROFESION"] == null && data["PROFESI√ìN"] != null) data["PROFESION"] = data["PROFESI√ìN"];
  if (data["NUMERO DE DOCUMENTO"] == null && data["N√öMERO DE DOCUMENTO"] != null) data["NUMERO DE DOCUMENTO"] = data["N√öMERO DE DOCUMENTO"];
  if (data["N√öMERO DE DOCUMENTO"] == null && data["NUMERO DE DOCUMENTO"] != null) data["N√öMERO DE DOCUMENTO"] = data["NUMERO DE DOCUMENTO"];

  const upper = {};
  for (const k in data) upper[k] = String(data[k] ?? "").toUpperCase();
  return upper;
}

async function generarODTUint8(base64, dataUpper){
  const bytes = Uint8Array.from(atob(base64.replace(/[\r\n\t ]+/g,"")), c=>c.charCodeAt(0));
  const zip = await JSZip.loadAsync(bytes);
  let xml = await zip.file("content.xml").async("string");

  for (const k in dataUpper){
    const v = (dataUpper[k] ?? "").toString();
    const rxExact = new RegExp("\\{\\{\\s*" + escRegex(k) + "\\s*\\}\\}","g");
    xml = xml.replace(rxExact, v);
    const kNoAcc = quitarAcentos(k).toUpperCase();
    if (kNoAcc !== k){
      const rxNoAcc = new RegExp("\\{\\{\\s*" + escRegex(kNoAcc) + "\\s*\\}\\}","g");
      xml = xml.replace(rxNoAcc, v);
    }
  }
  for (const k in dataUpper){
    const v = (dataUpper[k] ?? "").toString();
    const flex = buildFlexibleRegex(k);
    xml = xml.replace(flex, v);
    const flexNoAcc = buildFlexibleRegex(quitarAcentos(k));
    xml = xml.replace(flexNoAcc, v);
  }
  xml = xml.replace(/{{\s*[^}]+\s*}}/g,"");

  zip.file("content.xml", xml);
  return await zip.generateAsync({type:"uint8array", compression:"DEFLATE"});
}

async function generarROA(){
  const msg=document.getElementById("message");
  try{
    const plantilla =
      (typeof window !== 'undefined' && window.PLANTILLA_ROA && window.PLANTILLA_ROA.length) ? window.PLANTILLA_ROA :
      (window.PLANTILLAS && window.PLANTILLAS.roa) ? window.PLANTILLAS.roa :
      "";

    if(!plantilla){ msg.innerText="‚ùå Falta plantilla_roa.js (PLANTILLA_ROA)"; return; }

    const dataUpper = buildODTDataUpper();
    const odt = await generarODTUint8(plantilla, dataUpper);

    const nombre = (findFieldByName("NOMBRE")?.value||"").trim();
    const a1 = (findFieldByName("PRIMER APELLIDO")?.value||"").trim();
    const a2 = (findFieldByName("SEGUNDO APELLIDO")?.value||"").trim();
    const base = [nombre,a1,a2].filter(Boolean).join("_").replace(/[\/\\:*?"<>|]+/g," ").trim() || "ROA";

    const blob = new Blob([odt], {type:"application/vnd.oasis.opendocument.text"});
    saveAs(blob, `${base}_ROA.odt`);
    msg.innerText="‚úÖ R.O.A. generado";
  }catch(e){
    console.error(e);
    msg.innerText="‚ùå Error al generar R.O.A.: " + (e?.message || e);
  }
}

/* init: estado del ‚Äúotro‚Äù tipo doc */
window.addEventListener('DOMContentLoaded', ()=>{
  const sel=document.getElementById('tipoDocumento'), otro=document.getElementById('tipoDocumentoOtro');
  if(sel && otro){ otro.style.display = sel.value==="OTRO" ? "block":"none"; }
});
</script>
</body>
</html>
