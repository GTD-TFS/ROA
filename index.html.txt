<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>R.O.A. ‚Äì Carga desde Excel y Generaci√≥n ODT</title>

  <!-- Librer√≠as -->
  <script src="./jszip.min.js" defer></script>
  <script src="./FileSaver.min.js" defer></script>
  <script src="./xlsx.full.min.js" defer></script>
  <script src="./plantilla_roa.js" defer></script>

  <!-- Bootstrap para asegurar XLSX -->
  <script>
    (function () {
      function loadScript(src, ok, fail){
        var s=document.createElement('script');
        s.src=src; s.onload=ok; s.onerror=fail||function(){};
        document.head.appendChild(s);
      }
      window.ensureXLSX = function (cb){
        if (window.XLSX) { cb(); return; }
        loadScript('./xlsx.full.min.js', function(){ cb(); }, function(){
          loadScript('https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js', function(){ cb(); }, function(){
            var m=document.getElementById('message');
            if(m) m.innerText='‚ùå No se pudo cargar XLSX (local ni CDN).';
          });
        });
      };
    })();
  </script>

  <style>
    :root{
      --bg:#0f172a; --panel:#0b1222; --text:#e5e7eb; --muted:#9ca3af;
      --primary:#2563eb; --primary-2:#1d4ed8; --accent:#14b8a6;
      --card:#111827; --border:#243042; --radius:12px;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; font-family:Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 50% -200px, #12223d 0%, #0a0f1e 60%, #05060b 100%);
      color:var(--text); display:flex; flex-direction:column;
    }
    header{ width:100%; padding:16px 24px 0; }
    .title{ max-width:1600px; margin:0 auto; display:flex; align-items:center; justify-content:center; gap:16px; }
    .title h1{ margin:0; font-size:28px; font-weight:800; letter-spacing:.5px; color:#cfe3ff; text-shadow:0 2px 14px rgba(29,78,216,.55); }

    .actions{ max-width:1600px; margin:12px auto 0; display:flex; flex-direction:column; align-items:center; gap:12px; width:75%; }
    .btn{
      background:var(--primary); border:1px solid var(--primary-2);
      color:white; padding:12px 16px; border-radius:10px;
      font-weight:800; text-transform:uppercase; letter-spacing:.6px;
      cursor:pointer; transition:transform .06s ease, box-shadow .12s ease;
      width:100%;
    }
    .btn:hover{ transform:translateY(-1px); box-shadow:0 8px 20px rgba(37,99,235,.25); }
    .btn.secondary{ background:#0b1b33; border-color:#193052; }
    .btn.ok{ background:#15803d; border-color:#166534; }
    .btn.warn{ background:#b45309; border-color:#166534; }

    main{ width:100%; margin:16px 0 40px; display:flex; justify-content:center; }
    .wrap{
      width:clamp(1100px, 95vw, 1600px);
      background:linear-gradient(180deg, rgba(8,15,30,.7), rgba(8,15,30,.85));
      border:1px solid var(--border);
      box-shadow:0 30px 60px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.03);
      border-radius:16px; padding:22px 26px;
    }
    h2{
      margin:18px 0 8px; font-size:18px; letter-spacing:.4px; text-transform:uppercase;
      color:#b9d3ff; display:flex; align-items:center; gap:10px;
      border-bottom:2px solid #1f3b69; padding-bottom:6px;
    }
    .grid{ display:grid; gap:10px; grid-template-columns: repeat(4, minmax(180px,1fr)); }
    @media (max-width: 1280px){ .grid{ grid-template-columns: repeat(3, minmax(180px,1fr)); } }
    @media (max-width: 980px){ .grid{ grid-template-columns: repeat(2, minmax(180px,1fr)); } }

    .card{ background:linear-gradient(180deg, #0c1428, #0a1121); border:1px solid var(--border); border-radius:10px; padding:10px 10px 8px; display:flex; flex-direction:column; gap:6px; min-height:64px; }
    label{ font-size:12px; font-weight:800; text-transform:uppercase; letter-spacing:.6px; color:#9cc2ff; }
    input, select, textarea{
      width:100%; padding:7px 8px; border-radius:8px; border:1px solid #2a3955; background:#f8fafc;
      color:#0b1222; font-size:14px; outline:none;
    }
    textarea{ min-height:64px; resize:vertical; }
    input:focus, select:focus, textarea:focus{ box-shadow:0 0 0 2px rgba(100,180,255,.25); border-color:#4b86df; }

    .full{ grid-column: 1 / -1; }
    #message{ margin-top:12px; text-align:center; font-weight:700; color:#bfe5ff; min-height: 24px; }
    .mini{ display:none }
  </style>
</head>
<body>

  <header>
    <div class="title">
      <h1>RESUMEN OPERATIVO ARCHIVA (R.O.A.)</h1>
    </div>
  </header>

  <main>
    <div class="wrap">
      <!-- Apartado 1 -->
      <h2>ü™™ Identificaci√≥n</h2>
      <div class="grid">
        <div class="card">
          <label>Tipo de documento</label>
          <select id="tipoDocumento" name="TIPO DOCUMENTO_OPCION">
            <option value="INDOCUMENTADO/A">INDOCUMENTADO/A</option>
            <option value="DNI">DNI</option>
            <option value="NIE">NIE</option>
            <option value="PASAPORTE">PASAPORTE</option>
            <option value="OTRO">OTRO</option>
          </select>
          <input type="text" id="tipoDocumentoOtro" name="TIPO DOCUMENTO" placeholder="Especificar otro" style="display:none;">
        </div>
        <div class="card"><label>NUMERO DE DOCUMENTO</label><input type="text" id="numeroDocumento" name="N√öMERO DE DOCUMENTO"></div>
        <div class="card"><label>Nombre</label><input type="text" name="NOMBRE"></div>
        <div class="card"><label>Primer apellido</label><input type="text" name="PRIMER APELLIDO"></div>
        <div class="card"><label>Segundo apellido</label><input type="text" name="SEGUNDO APELLIDO"></div>
        <div class="card"><label>Fecha de nacimiento</label><input type="text" name="FECHA DE NACIMIENTO" placeholder="DD/MM/AAAA"></div>
        <div class="card"><label>Lugar de nacimiento</label><input type="text" name="LUGAR DE NACIMIENTO"></div>
        <div class="card"><label>Provincia</label><input type="text" name="PROVINCIA"></div>
        <div class="card"><label>PA√çS</label><input type="text" name="PA√çS"></div>
        <div class="card"><label>NACIONALIDAD</label><input type="text" name="NACIONALIDAD"></div>
        <div class="card"><label>Nombre de los padres</label><input type="text" name="NOMBRE DE LOS PADRES"></div>
        <div class="card"><label>PROFESI√ìN</label><input type="text" name="PROFESI√ìN"></div>
      </div>

      <!-- Apartado 2 -->
      <h2>üìÇ Entorno y Actividad</h2>
      <div class="grid">
        <div class="card"><label>Tel√©fono</label><input type="text" name="TEL√âFONO" placeholder="TEL√âFONO"></div>
        <div class="card"><label>Armas</label><input type="text" name="ARMAS"></div>
        <div class="card"><label>Alias</label><input type="text" name="ALIAS"></div>
        <div class="card"><label>Consortes</label><input type="text" name="CONSORTES"></div>
        <div class="card"><label>Domicilios</label><input type="text" name="DOMICILIOS"></div>
        <div class="card"><label>Empresas</label><input type="text" name="EMPRESAS"></div>
        <div class="card"><label>Lugares de actuaci√≥n</label><input type="text" name="LUGARES DE ACTUACION"></div>
        <div class="card"><label>Lugares de frecuencia</label><input type="text" name="LUGARES DE FRECUENCIA"></div>
        <div class="card"><label>Organizaci√≥n</label><input type="text" name="ORGANIZACION"></div>
      </div>

      <!-- Apartado 3 -->
      <h2>üß¨ Rasgos f√≠sicos</h2>
      <div class="grid">
        <div class="card">
          <label>Sexo</label>
          <select name="SEXO" id="sexo">
            <option value="">--</option>
            <option value="H">Masculino</option>
            <option value="M">Femenino</option>
          </select>
        </div>
        <div class="card"><label>Talla</label><input type="text" name="TALLA"></div>
        <div class="card"><label>Complexi√≥n</label><input type="text" name="COMPLEXION"></div>
        <div class="card"><label>Raza</label><input type="text" name="RAZA"></div>
        <div class="card"><label>Acento</label><input type="text" name="ACENTO"></div>
        <div class="card"><label>Cejas</label><input type="text" name="CEJAS"></div>
        <div class="card"><label>Labios</label><input type="text" name="LABIOS"></div>
        <div class="card"><label>Ment√≥n</label><input type="text" name="MENTON"></div>
        <div class="card"><label>Cara</label><input type="text" name="CARA"></div>
        <div class="card"><label>Pelo</label><input type="text" name="PELO"></div>
        <div class="card"><label>Ojos</label><input type="text" name="OJOS"></div>
        <div class="card"><label>Nariz</label><input type="text" name="NARIZ"></div>
        <div class="card"><label>Orejas</label><input type="text" name="OREJAS"></div>
        <div class="card full"><label>Marcas</label><textarea name="MARCAS"></textarea></div>
      </div>

      <!-- Apartado 4 -->
      <h2>üöó Otros</h2>
      <div class="grid">
        <div class="card"><label>Usas</label><input type="text" name="USAS"></div>
        <div class="card"><label>Veh√≠culos</label><input type="text" name="VEHICULOS"></div>
      </div>

      <!-- Apartado 5 -->
      <h2>üìù Observaciones</h2>
      <div class="grid">
        <div class="card"><label>Diligencias</label><input type="text" name="DILIGENCIAS"></div>
        <div class="card"><label>Fecha diligencias</label><input type="text" name="FECHA DILIGENCIAS" placeholder="DD/MM/AAAA"></div>
        <div class="card full">
          <label>Resumen diligencias</label>
          <textarea name="RESUMEN DILIGENCIAS"></textarea>
        </div>
      </div>

      <!-- Apartado 6 -->
      <h2>üëÆ Finalizaci√≥n</h2>
      <div class="grid">
        <div class="card"><label>Funcionario emisor</label><input type="text" name="FUNCIONARIO EMISOR"></div>
        <div class="card"><label>Fecha de cumplimentaci√≥n</label><input type="text" name="FECHA DE CUMPLIMENTACION" placeholder="DD/MM/AAAA"></div>
      </div>

      <div id="message"></div>
    </div>
  </main>

  <!-- Botones -->
  <div class="actions">
    <input type="file" id="fileInputXLSX" class="mini" accept=".xlsx,.xls" />
    <button class="btn secondary" type="button" style="background:#BDB76B" onclick="cargarExcel()">üìÅ Cargar EXCEL</button>
    <button class="btn ok"        type="button" style="background:#006400" onclick="generarROA()">‚¨áÔ∏è Descargar R.O.A.</button>
    <button class="btn warn"      type="button" style="background:#0000FF" onclick="refrescarFuerte()">‚ü≤ Refrescar</button>
  </div>

  <script>
  // TODA tu l√≥gica de Excel, aliases, findFieldByKey, cargarExcel(), etc.
  // === Aqu√≠ solo remarco el cambio en generarODTUint8 ===

  async function generarODTUint8(base64, dataUpper){
    const bytes = Uint8Array.from(atob(base64.replace(/[\r\n\t ]+/g,"")), c=>c.charCodeAt(0));
    const zip = await JSZip.loadAsync(bytes);
    let xml = await zip.file("content.xml").async("string");

    // üîß Normalizador seguro de placeholders en XML
    (function () {
      const FIELD_MAP = {
        "PA√çS": ["PAIS", "PA√çS"],
        "NACIONALIDAD": ["NACIONALIDAD"],
        "N√öMERO DE DOCUMENTO": ["NUMERO DE DOCUMENTO","N√öMERO DE DOCUMENTO","NUMERO DOCUMENTO","N√öMERO DOCUMENTO"],
        "PROFESI√ìN": ["PROFESION","PROFESI√ìN"],
        "TIPO DOCUMENTO": ["TIPO DOCUMENTO","TIPO DE DOCUMENTO"]
      };
      const stripAccents = s => s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
      const esc = s => s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
      const SEP = String.raw`(?:\s|<[^>]+>|&nbsp;)*`;
      const lettersPat = s => s.split('').map(ch => esc(ch)).join(SEP);
      function makeBrokenTokenRx(token){
        const up = token.toUpperCase();
        const upNoAcc = stripAccents(up);
        const inner = `(?:${lettersPat(up)}|${lettersPat(upNoAcc)})`;
        const pattern = String.raw`\{${SEP}\{${SEP}${inner}${SEP}\}${SEP}\}`;
        return new RegExp(pattern,'gsi');
      }
      function normalizeXml(src, outKey, variants){
        for(const v of variants){ src = src.replace(makeBrokenTokenRx(v), `{{${outKey}}}`); }
        const tight = new RegExp(String.raw`\{\{\s*${esc(outKey)}\s*\}\}`,'gi');
        return src.replace(tight, `{{${outKey}}}`);
      }
      for (const [outKey, variants] of Object.entries(FIELD_MAP)){
        xml = normalizeXml(xml, outKey, variants);
      }
    })();

    // ... aqu√≠ sigue tu c√≥digo para reemplazar placeholders con dataUpper ...

    zip.file("content.xml", xml);
    return await zip.generateAsync({type:"uint8array", compression:"DEFLATE"});
  }
  </script>
</body>
</html>
